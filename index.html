<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¶å¯å¤¢æŠ½æŠ½æ¨‚ Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap');
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* 5x6 æŠ½çç¶²æ ¼ */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            width: 100%;
            max-width: 480px;
            margin: 0 auto;
        }

        .card { 
            width: 100%; 
            padding-bottom: 100%; 
            perspective: 1000px; 
            cursor: pointer; 
            position: relative;
        }
        .card-inner {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d;
        }
        .card.flipped .card-inner { transform: rotateY(180deg); }
        
        .card-front, .card-back {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            backface-visibility: hidden;
            border-radius: 12px; 
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -1px rgba(0,0,0,0.06);
            display: flex; justify-content: center; align-items: center;
        }

        .card-front { background-color: #e2e8f0; }

        /* ç´” CSS å®Œç¾é‡ç¾ç²¾éˆçƒåœ–æ¡ˆ */
        .pokeball-design {
            width: 85%;
            height: 85%;
            border-radius: 50%;
            background: linear-gradient(to bottom, #ca2027 46%, #151a2a 46%, #151a2a 54%, #f1f1f1 54%);
            border: 4px solid #151a2a;
            position: relative;
            box-shadow: inset -4px -4px 8px rgba(0,0,0,0.15);
        }
        .pokeball-design::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 32%;
            height: 32%;
            background: #f1f1f1;
            border: 4px solid #151a2a;
            border-radius: 50%;
            box-shadow: inset -2px -2px 4px rgba(0,0,0,0.1);
        }

        .card-back { 
            background-color: white; 
            transform: rotateY(180deg); 
            border: 2px solid #cbd5e1;
            padding: 4px;
        }

        @keyframes imgShake {
            0% { transform: scale(0); opacity: 0; }
            10% { transform: scale(1.5); opacity: 1; }
            15%, 25%, 35%, 45%, 55%, 65%, 75%, 85% { transform: scale(1.5) rotate(10deg); }
            20%, 30%, 40%, 50%, 60%, 70%, 80%, 90% { transform: scale(1.5) rotate(-10deg); }
            95% { transform: scale(1.5) rotate(0deg); opacity: 1; }
            100% { transform: scale(0); opacity: 0; }
        }

        @keyframes textFade {
            0% { opacity: 0; transform: translateY(10px); }
            10%, 90% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }

        #rewardPopup {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 100; pointer-events: none; display: none; 
            flex-direction: column; align-items: center;
        }
        
        #rewardPopup.active { display: flex; }
        
        #rewardPopup.active #popupImg {
            animation: imgShake var(--anim-duration, 1.5s) cubic-bezier(0.25, 1, 0.5, 1) forwards;
        }

        #rewardPopup.active #popupText {
            animation: textFade var(--anim-duration, 1.5s) ease-in-out forwards;
        }

        .inventory-slot {
            width: 45px; height: 45px;
            background: rgba(0,0,0,0.05);
            border: 2px dashed #cbd5e1;
            border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            transition: all 0.3s ease;
            padding: 4px;
        }
        .inventory-slot.filled {
            background: white;
            border: 2px solid #ef4444;
            box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
            transform: scale(1.1);
        }

        #loadingOverlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.8);
            justify-content: center; align-items: center;
            z-index: 200;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-6 px-4 relative">

    <!-- è‡ªè¨‚è¨Šæ¯æç¤ºæ¡† -->
    <div id="customAlert" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-6 py-3 rounded-xl shadow-2xl z-50 transition-opacity duration-300 opacity-0 pointer-events-none font-bold text-lg text-center min-w-[300px]">
        <span id="customAlertText"></span>
    </div>

    <!-- åˆªé™¤ç¢ºèªå°è©±æ¡† -->
    <div id="confirmModal" class="fixed top-0 left-0 w-full h-full bg-black/60 z-[400] hidden justify-center items-center opacity-0 transition-opacity duration-300">
        <div class="bg-white p-6 rounded-2xl shadow-2xl text-center max-w-sm mx-4 transform scale-90 transition-transform duration-300" id="confirmModalBox">
            <h3 class="text-xl font-bold mb-6 text-gray-800" id="confirmModalText">ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ</h3>
            <div class="flex justify-center gap-4">
                <button id="confirmCancelBtn" class="flex-1 px-4 py-3 bg-gray-200 rounded-xl font-bold text-gray-700 hover:bg-gray-300 transition-colors">å–æ¶ˆ</button>
                <button id="confirmOkBtn" class="flex-1 px-4 py-3 bg-red-500 rounded-xl font-bold text-white hover:bg-red-600 transition-colors">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- è¼‰å…¥ä¸­é®ç½© -->
    <div id="loadingOverlay" class="hidden flex-col gap-4">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-red-600"></div>
        <div class="text-xl font-bold text-gray-700">æº–å‚™ä¸­...</div>
    </div>

    <!-- å±•ç¤ºå“æ”¾å¤§ç‡ˆç®± -->
    <div id="lightbox" class="fixed top-0 left-0 w-full h-full bg-black/80 z-[300] hidden justify-center items-center cursor-pointer opacity-0 transition-opacity duration-300">
        <div class="flex flex-col items-center">
            <img id="lightboxImg" src="" class="max-w-[80%] max-h-[60vh] object-contain transform scale-50 transition-transform duration-300 drop-shadow-2xl">
            <!-- å¯¶å¯å¤¢åç¨±é¡¯ç¤ºå€å¡Š -->
            <div id="lightboxText" class="text-white text-3xl font-black mt-4 tracking-widest opacity-0 transition-opacity duration-300 drop-shadow-md text-center px-4"></div>
            <!-- åœ–é‘‘é€£çµ -->
            <a id="lightboxLink" href="#" target="_blank" class="mt-4 px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-bold rounded-full shadow-lg opacity-0 transition-opacity duration-300 hidden">æŸ¥çœ‹åœ–é‘‘è³‡è¨Š</a>
        </div>
    </div>

    <!-- æ¨™é¡Œå€ -->
    <header class="text-center mb-6">
        <h1 class="text-4xl font-black text-gray-800 tracking-wider mb-2">
            <span class="text-red-600">å¯¶å¯å¤¢</span> æŠ½æŠ½æ¨‚
        </h1>
        <p class="text-gray-500 font-medium">æ”¶é›† 10 é¡†å¯¶è²çƒé”æˆç›®æ¨™ï¼</p>
    </header>
    
    <!-- Google ç™»å…¥å€å¡Š (æœªç™»å…¥æ™‚é¡¯ç¤º) -->
    <div id="googleLoginSection" class="w-full max-w-md bg-white p-8 rounded-2xl shadow-lg mb-6 text-center">
        <h2 class="text-2xl font-bold mb-6 text-gray-800">ç™»å…¥ä»¥è·¨è£ç½®åŒæ­¥é€²åº¦</h2>
        <button id="googleSignInBtn" class="w-full flex items-center justify-center gap-3 bg-white border-2 border-gray-200 text-gray-700 px-6 py-3 rounded-xl hover:bg-gray-50 font-bold text-lg transition-colors shadow-sm">
            <svg class="w-6 h-6" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg>
            ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
        </button>
    </div>

    <!-- ç©å®¶é¸æ“‡å€å¡Š (ç™»å…¥å¾Œé¡¯ç¤º) -->
    <div id="loginSection" class="hidden w-full max-w-md bg-white p-6 rounded-2xl shadow-lg mb-6 text-center relative">
        <!-- ç™»å‡ºæŒ‰éˆ• -->
        <button id="logoutBtn" class="absolute top-4 right-4 text-sm text-gray-500 hover:text-red-500 font-bold underline">ç™»å‡º</button>
        
        <h2 class="text-2xl font-bold mb-2 text-blue-600" id="userGreeting">æº–å‚™é–‹å§‹</h2>
        <p class="text-sm text-gray-500 mb-4">ä½ çš„æ‰€æœ‰ç´€éŒ„éƒ½æœƒå®‰å…¨åœ°ç¶å®šåœ¨æ­¤å¸³è™Ÿä¸‹</p>

        <div class="flex gap-2 mb-4 w-full">
            <select id="userSelect" class="flex-1 p-3 border-2 border-gray-300 rounded-xl text-lg focus:border-blue-500 focus:outline-none bg-gray-50 font-bold text-gray-700 cursor-pointer">
                <option value="">-- é¸æ“‡æ›¾éŠç©çš„ç´€éŒ„ --</option>
            </select>
            <button type="button" id="deletePlayerBtn" class="hidden bg-gray-300 text-gray-700 px-4 py-3 rounded-xl hover:bg-red-500 hover:text-white font-bold transition-colors shadow-sm whitespace-nowrap" title="åˆªé™¤é¸å®šç©å®¶çš„ç´€éŒ„">
                åˆªé™¤
            </button>
        </div>

        <div class="flex gap-2 mb-4">
            <input type="text" id="userNameInput" placeholder="è¼¸å…¥ç´€éŒ„åç¨±(å¦‚:å°æ˜)" class="flex-1 p-3 border-2 border-gray-300 rounded-xl text-lg focus:border-blue-500 focus:outline-none">
            <input type="number" id="daysInput" placeholder="å¤©æ•¸" value="3" min="1" class="w-24 p-3 border-2 border-gray-300 rounded-xl text-lg focus:border-blue-500 focus:outline-none text-center" title="è¨­å®šæŒ‘æˆ°å¤©æ•¸">
        </div>
        <button type="button" id="loginBtn" class="w-full bg-red-500 text-white px-6 py-3 rounded-xl hover:bg-red-600 font-bold text-lg transition-colors shadow-md">é€²å…¥éŠæˆ²</button>
    </div>

    <!-- éŠæˆ²å€åŸŸ -->
    <div id="gameArea" class="hidden w-full flex-col items-center">
        <div id="timerSection" class="w-full max-w-md bg-red-100 p-4 rounded-2xl shadow-lg mb-6 text-center border-2 border-red-300 relative">
            <h2 class="text-lg font-bold text-red-700 mb-1">
                æŒ‘æˆ°å€’æ•¸ <span id="playerNameDisplay" class="text-sm text-red-500 font-normal ml-2"></span>
            </h2>
            <div id="timer" class="text-4xl font-black text-red-600 tracking-widest">00:00:00</div>
            <button type="button" id="switchPlayerBtn" class="absolute top-3 right-3 bg-white text-red-600 border border-red-300 px-3 py-1 rounded-lg text-sm font-bold shadow-sm hover:bg-red-50 transition-colors">
                åˆ‡æ›ç´€éŒ„
            </button>
        </div>

        <!-- æ•¸æ“šçœ‹æ¿ -->
        <div class="grid grid-cols-2 gap-4 w-full max-w-md mb-6">
            <div class="bg-blue-500 text-white p-3 rounded-2xl shadow-lg text-center">
                <div class="text-xs opacity-80">å·²æ”¶é›†å¯¶å¯å¤¢</div>
                <div class="text-2xl font-bold"><span id="pokeCount">0</span> <small class="text-sm">/ 5</small></div>
            </div>
            <div class="bg-red-500 text-white p-3 rounded-2xl shadow-lg text-center">
                <div class="text-xs opacity-80">ç›´æ¥æŠ½ä¸­å¯¶è²çƒ</div>
                <div class="text-2xl font-bold" id="ballCount">0</div>
            </div>
        </div>

        <!-- 5x6 æŠ½çç¶²æ ¼ -->
        <div class="game-grid mb-8" id="gameGrid"></div>

        <!-- å¯¶è²çƒé€²åº¦åˆ— (10é¡†) -->
        <div class="w-full max-w-xl bg-white p-6 rounded-3xl shadow-xl border-t-4 border-red-500 mb-8">
            <h3 class="text-center font-bold text-gray-700 mb-4">ğŸ† å¯¶è²çƒæ”¶é›†é€²åº¦ (<span id="totalBalls">0</span>/10)</h3>
            <div class="flex flex-wrap justify-center gap-3" id="inventoryContainer">
                <!-- ç”± JS ç”Ÿæˆ 10 å€‹æ ¼å­ -->
            </div>
        </div>
    </div>

    <!-- ä¸­å¤®å½ˆå‡ºç‰¹æ•ˆçµ„ä»¶ -->
    <div id="rewardPopup">
        <img id="popupImg" src="" class="w-48 h-48 object-contain drop-shadow-xl" alt="Pokemon">
        <div id="popupText" class="bg-yellow-400 text-red-700 px-6 py-2 rounded-full font-black text-xl text-center shadow-xl border-4 border-white mt-[-20px] z-10 relative">
            æ”¶æœäº†ï¼
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, deleteDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // å°å…¥ Google ç™»å…¥æ‰€éœ€æ¨¡çµ„
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        let db, auth, appId, provider;
        let authReady = false;
        let userDocRef = null;
        let currentUser = ""; 

        // 1. è«‹å°‡é€™è£¡æ›æˆä½ åœ¨ Firebase å–å¾—çš„ config
        const firebaseConfig = {
  apiKey: "AIzaSyA2Q53dRqxUTVIMm7yqTHHOrLT4ShBgsPY",
  authDomain: "pokemongacha-9ffb2.firebaseapp.com",
  projectId: "pokemongacha-9ffb2",
  storageBucket: "pokemongacha-9ffb2.firebasestorage.app",
  messagingSenderId: "64620615601",
  appId: "1:64620615601:web:c32aa81b8943a0398d0f90",
  measurementId: "G-HBXX9S8G93"
        };
        appId = 'pokemon-gacha-app'; 

        // 2. åˆå§‹åŒ– Firebase
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            provider = new GoogleAuthProvider();

            // ç›£è½ç™»å…¥ç‹€æ…‹
            onAuthStateChanged(auth, (user) => {
                authReady = true;
                if (user && !user.isAnonymous) {
                    // å·²ä½¿ç”¨ Google ç™»å…¥
                    document.getElementById('googleLoginSection').classList.add('hidden');
                    document.getElementById('loginSection').classList.remove('hidden');
                    document.getElementById('userGreeting').innerText = `ä½ å¥½ï¼Œ${user.displayName || 'ç©å®¶'}ï¼`;
                } else {
                    // æœªç™»å…¥
                    document.getElementById('googleLoginSection').classList.remove('hidden');
                    document.getElementById('loginSection').classList.add('hidden');
                    document.getElementById('gameArea').classList.add('hidden');
                    document.getElementById('gameArea').classList.remove('flex');
                    clearInterval(timerInterval);
                }
            });
        } catch (e) {
            console.error("Firebase åˆå§‹åŒ–éŒ¯èª¤:", e);
        }

        let state = { pokes: 0, directBalls: 0, totalBalls: 0, isGameOver: false, deadline: null, cards: [] };
        let timerInterval = null;
        let isOfflineMode = false; 
        let playerToDelete = ""; 
        
        const BALL_IMG = "https://upload.wikimedia.org/wikipedia/commons/5/53/Pok%C3%A9_Ball_icon.svg";

        const SOUND_ITEM = new Audio('https://www.myinstants.com/media/sounds/pokemon-item-received.mp3');
        const SOUND_PIKA = new Audio('https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/25.ogg');

        function playSound(audioObj) {
            audioObj.currentTime = 0; 
            audioObj.play().catch(e => console.warn("éŸ³æ•ˆå¯èƒ½å› ç€è¦½å™¨æ”¿ç­–è¢«é˜»æ“‹:", e));
        }

        // === ç™»å…¥/ç™»å‡ºäº‹ä»¶ ===
        document.getElementById('googleSignInBtn').addEventListener('click', async () => {
            showLoading(true);
            try {
                await signInWithPopup(auth, provider);
            } catch (error) {
                console.error("ç™»å…¥å¤±æ•—", error);
                showAlert("Google ç™»å…¥å¤±æ•—æˆ–å·²å–æ¶ˆ");
            } finally {
                showLoading(false);
            }
        });

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await signOut(auth);
            showAlert("å·²æˆåŠŸç™»å‡º");
        });

        // === æœ¬åœ°ç©å®¶ç´€éŒ„ç®¡ç† ===
        function getSavedPlayers() {
            try { return JSON.parse(localStorage.getItem('pokemon_players')) || []; } 
            catch { return []; }
        }

        function savePlayerLocal(name, days) {
            let players = getSavedPlayers();
            let existing = players.find(p => p.name === name);
            if (existing) { existing.days = days; } 
            else { players.push({name, days}); }
            localStorage.setItem('pokemon_players', JSON.stringify(players));
            renderPlayerDropdown();
        }

        function renderPlayerDropdown() {
            const select = document.getElementById('userSelect');
            const players = getSavedPlayers();
            select.innerHTML = '<option value="">-- é¸æ“‡æ›¾éŠç©çš„ç´€éŒ„ --</option>';
            players.forEach(p => {
                select.innerHTML += `<option value="${p.name}">${p.name} (æŒ‘æˆ° ${p.days} å¤©)</option>`;
            });
        }

        document.getElementById('userSelect').addEventListener('change', (e) => {
            const name = e.target.value;
            const delBtn = document.getElementById('deletePlayerBtn');
            if (name) {
                delBtn.classList.remove('hidden');
                const p = getSavedPlayers().find(x => x.name === name);
                document.getElementById('userNameInput').value = p.name;
                document.getElementById('daysInput').value = p.days;
            } else {
                delBtn.classList.add('hidden');
                document.getElementById('userNameInput').value = '';
                document.getElementById('daysInput').value = '3';
            }
        });

        document.getElementById('deletePlayerBtn').addEventListener('click', (e) => {
            e.preventDefault();
            const name = document.getElementById('userSelect').value;
            if (!name) return;
            
            playerToDelete = name;
            document.getElementById('confirmModalText').innerText = `ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€çš„æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ`;
            
            const modal = document.getElementById('confirmModal');
            const box = document.getElementById('confirmModalBox');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            void modal.offsetWidth; 
            modal.classList.remove('opacity-0');
            box.classList.remove('scale-90');
            box.classList.add('scale-100');
        });

        document.getElementById('confirmCancelBtn').addEventListener('click', () => {
            playerToDelete = "";
            const modal = document.getElementById('confirmModal');
            const box = document.getElementById('confirmModalBox');
            modal.classList.add('opacity-0');
            box.classList.remove('scale-100');
            box.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);
        });

        document.getElementById('confirmOkBtn').addEventListener('click', async () => {
            const name = playerToDelete;
            const modal = document.getElementById('confirmModal');
            const box = document.getElementById('confirmModalBox');
            
            modal.classList.add('opacity-0');
            box.classList.remove('scale-100');
            box.classList.add('scale-90');
            setTimeout(() => {
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            }, 300);

            if (!name) return;

            try {
                let players = getSavedPlayers().filter(p => p.name !== name);
                localStorage.setItem('pokemon_players', JSON.stringify(players));
                localStorage.removeItem(`pokemon_save_${name}`);

                if (db && auth && auth.currentUser) {
                    const userId = auth.currentUser.uid;
                    const docRef = doc(db, 'artifacts', appId, 'users', userId, 'pokemon_saves', name);
                    await deleteDoc(docRef);
                }
            } catch(err) { 
                console.warn("åˆªé™¤éç¨‹å‡ºç¾éƒ¨åˆ†å•é¡Œ", err); 
            }

            showAlert(`å·²åˆªé™¤ ${name} çš„ç´€éŒ„ï¼`);
            renderPlayerDropdown();
            
            document.getElementById('deletePlayerBtn').classList.add('hidden');
            document.getElementById('userNameInput').value = '';
            document.getElementById('daysInput').value = '3';
            playerToDelete = "";
        });

        renderPlayerDropdown();

        // === UI èˆ‡ç‰¹æ•ˆå·¥å…· ===
        function showAlert(msg) {
            const alertBox = document.getElementById('customAlert');
            document.getElementById('customAlertText').innerText = msg;
            alertBox.classList.remove('opacity-0', 'pointer-events-none');
            setTimeout(() => alertBox.classList.add('opacity-0', 'pointer-events-none'), 3000);
        }

        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) { overlay.classList.remove('hidden'); overlay.classList.add('flex'); } 
            else { overlay.classList.remove('flex'); overlay.classList.add('hidden'); }
        }

        function showLightbox(data) {
            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightboxImg');
            const lbText = document.getElementById('lightboxText');
            const lbLink = document.getElementById('lightboxLink');
            
            lbImg.src = data.img;
            lbText.innerText = 'è¼‰å…¥ä¸­...';
            lbText.classList.remove('opacity-0');
            lbLink.classList.add('hidden');
            lbLink.classList.add('opacity-0');

            if (data.type === 'ball') {
                lbText.innerText = 'å¯¶è²çƒ (PokÃ© Ball)';
            } else {
                const pokeId = data.img.split('/').pop().split('.')[0];
                fetch(`https://pokeapi.co/api/v2/pokemon-species/${pokeId}`)
                    .then(res => res.json())
                    .then(resData => {
                        const twNameObj = resData.names.find(n => n.language.name === 'zh-Hant') || resData.names.find(n => n.language.name === 'zh-Hans');
                        const enNameObj = resData.names.find(n => n.language.name === 'en');
                        
                        const twName = twNameObj ? twNameObj.name : '';
                        const enName = enNameObj ? enNameObj.name : resData.name;
                        const capitalizedEnName = enName.charAt(0).toUpperCase() + enName.slice(1);
                        
                        lbText.innerText = twName ? `${twName} (${capitalizedEnName})` : capitalizedEnName;

                        lbLink.href = twName ? `https://wiki.52poke.com/wiki/${twName}` : `https://wiki.52poke.com/wiki/${capitalizedEnName}`;
                        lbLink.classList.remove('hidden');
                        setTimeout(() => lbLink.classList.remove('opacity-0'), 100);
                    })
                    .catch(() => {
                        lbText.innerText = `å¯¶å¯å¤¢ #${pokeId}`;
                    });
            }

            lb.classList.remove('hidden');
            lb.classList.add('flex'); 
            void lb.offsetWidth; 
            lb.classList.remove('opacity-0');
            lbImg.classList.remove('scale-50');
            lbImg.classList.add('scale-100');
        }

        document.getElementById('lightbox').addEventListener('click', (e) => {
            if(e.target.id === 'lightboxLink') return;

            const lb = document.getElementById('lightbox');
            const lbImg = document.getElementById('lightboxImg');
            const lbText = document.getElementById('lightboxText');
            const lbLink = document.getElementById('lightboxLink');
            
            lb.classList.add('opacity-0');
            lbImg.classList.remove('scale-100');
            lbImg.classList.add('scale-50');
            lbText.classList.add('opacity-0');
            lbLink.classList.add('opacity-0');
            
            setTimeout(() => {
                lb.classList.add('hidden');
                lb.classList.remove('flex');
            }, 300);
        });

        function showDrawAnimation(imgSrc, text, useConfetti, isPikachuBonus = false) {
            const popup = document.getElementById('rewardPopup');
            document.getElementById('popupImg').src = imgSrc;
            document.getElementById('popupText').innerText = text;
            
            const duration = isPikachuBonus ? 3500 : 1500;
            popup.style.setProperty('--anim-duration', `${duration}ms`);

            if(useConfetti && window.confetti) {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#ff0000', '#ffcc00', '#ffffff'] });
            }
            
            popup.classList.add('active');
            setTimeout(() => popup.classList.remove('active'), duration);
        }

        function initInventory() {
            const container = document.getElementById('inventoryContainer');
            container.innerHTML = '';
            for (let i = 0; i < 10; i++) {
                const slot = document.createElement('div');
                slot.classList.add('inventory-slot');
                slot.id = `slot-${i}`;
                container.appendChild(slot);
            }
        }

        function getRandomPokeIds(count) {
            const ids = new Set();
            while(ids.size < count) ids.add(Math.floor(Math.random() * 386) + 1);
            return Array.from(ids);
        }

        function initGame() {
            initInventory();
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = '';
            
            const pokeIds = getRandomPokeIds(25);
            let cardsData = [
                ...Array(5).fill({ type: 'ball', img: BALL_IMG }),
                ...pokeIds.map(id => ({ type: 'pokemon', img: `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png` }))
            ];
            cardsData.sort(() => Math.random() - 0.5);

            cardsData.forEach((data) => {
                const card = document.createElement('div');
                card.className = 'card pointer-events-none'; 
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front"><div class="pokeball-design"></div></div>
                        <div class="card-back">
                            <img src="${data.img}" class="w-full h-full object-contain" crossorigin="anonymous">
                        </div>
                    </div>
                `;
                card.onclick = () => handleFlip(card, data);
                grid.appendChild(card);
            });
        }

        function startGame() {
            document.querySelectorAll('.card').forEach(card => {
                if (!card.classList.contains('flipped')) card.classList.remove('pointer-events-none');
            });
        }

        function handleFlip(el, data) {
            if (el.classList.contains('flipped')) {
                showLightbox(data);
                return;
            }
            
            if (state.isGameOver) return;
            
            el.classList.add('flipped');

            if (data.type === 'ball') {
                state.directBalls++;
                
                playSound(SOUND_ITEM);

                showDrawAnimation(BALL_IMG, "ç›´æ¥ç²å¾—å¯¶è²çƒï¼", true, false);
                updateUI();
                saveProgress(true); 
            } else {
                state.pokes++;
                
                showDrawAnimation(data.img, "æ”¶æœäº†ï¼", false, false);
                
                setTimeout(() => {
                    if (state.pokes > 0 && state.pokes % 5 === 0) {
                        playSound(SOUND_PIKA); 
                        setTimeout(() => playSound(SOUND_ITEM), 800); 
                        showDrawAnimation("https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/25.png", "é›†æ»¿ 5 éš»ï¼å…Œæ›å¯¶è²çƒï¼", true, true);
                    }
                    updateUI();
                    saveProgress(true); 
                }, 1600);
            }
        }

        function updateUI() {
            state.totalBalls = state.directBalls + Math.floor(state.pokes / 5);
            document.getElementById('pokeCount').innerText = state.pokes % 5;
            document.getElementById('ballCount').innerText = state.directBalls;
            document.getElementById('totalBalls').innerText = state.totalBalls;

            for (let i = 0; i < 10; i++) {
                const slot = document.getElementById(`slot-${i}`);
                if (i < state.totalBalls && !slot.classList.contains('filled')) {
                    slot.classList.add('filled');
                    slot.innerHTML = `<img src="${BALL_IMG}" class="w-full h-full object-contain animate-bounce drop-shadow-md">`;
                }
            }

            if (state.totalBalls >= 10 && !state.isGameOver) {
                state.isGameOver = true;
                setTimeout(() => {
                    if(window.confetti) confetti({ particleCount: 500, spread: 160 });
                    showAlert("ğŸ‰ æ­å–œé”æˆç›®æ¨™ï¼ä½ å·²ç¶“æˆç‚ºå¯¶å¯å¤¢å¤§å¸«äº†ï¼");
                }, 1000);
                saveProgress(true); 
            }
        }

        const fetchWithTimeout = async (promise, ms) => {
            let timeoutId;
            const timeoutPromise = new Promise((_, reject) => {
                timeoutId = setTimeout(() => reject(new Error('TIMEOUT')), ms);
            });
            return Promise.race([promise, timeoutPromise]).finally(() => clearTimeout(timeoutId));
        };

        document.getElementById('loginBtn').addEventListener('click', async (e) => {
            e.preventDefault();
            const name = document.getElementById('userNameInput').value.trim();
            const days = parseInt(document.getElementById('daysInput').value) || 3;
            
            if (!name) {
                showAlert('è«‹è¼¸å…¥ç´€éŒ„åç¨±æˆ–é¸æ“‡ç©å®¶ï¼');
                return;
            }

            currentUser = name;
            savePlayerLocal(name, days);
            showLoading(true);

            try {
                if (!authReady || !auth || !auth.currentUser) isOfflineMode = true;

                if (!isOfflineMode) {
                    try {
                        const userId = auth.currentUser.uid;
                        userDocRef = doc(db, 'artifacts', appId, 'users', userId, 'pokemon_saves', name);

                        const docSnap = await fetchWithTimeout(getDoc(userDocRef), 2000);
                        if (docSnap.exists()) {
                            const data = docSnap.data();
                            if (data.deadline && data.deadline.toDate && data.deadline.toDate() < new Date()) {
                                showAlert('éŠæˆ²æœŸé™å·²éï¼Œå·²ç‚ºä½ é‡æ–°é–‹å§‹ï¼');
                                startNewGame(days);
                            } else if (data.grid && data.deadline && data.deadline.toDate) {
                                showAlert(`è®€å–æˆåŠŸï¼è¼‰å…¥ç´€éŒ„ï¼š${name}`);
                                state = { ...state, ...data, deadline: data.deadline.toDate() };
                                loadSavedGrid(data.grid); 
                                updateUI();
                                startGame();
                            } else {
                                startNewGame(days); 
                            }
                        } else {
                            showAlert(`å»ºç«‹æ–°ç´€éŒ„ï¼š${name}ï¼Œé–‹å§‹æŒ‘æˆ°ï¼`);
                            startNewGame(days);
                        }
                    } catch (error) {
                        console.warn("è®€å–å¤±æ•—ï¼Œé€²å…¥å–®æ©Ÿæ¨¡å¼:", error);
                        isOfflineMode = true;
                    }
                }

                if (isOfflineMode) {
                    const savedDataStr = localStorage.getItem(`pokemon_save_${currentUser}`);
                    if (savedDataStr) {
                        const data = JSON.parse(savedDataStr);
                        const savedDeadline = new Date(data.deadline);
                        if (savedDeadline < new Date()) {
                            showAlert('éŠæˆ²æœŸé™å·²éï¼Œå·²ç‚ºä½ é‡æ–°é–‹å§‹ï¼');
                            startNewGame(days);
                        } else if (data.grid) {
                            showAlert(`è®€å–æˆåŠŸï¼è¼‰å…¥å–®æ©Ÿç´€éŒ„ï¼š${name}`);
                            state = { ...state, ...data, deadline: savedDeadline };
                            loadSavedGrid(data.grid); 
                            updateUI();
                            startGame();
                        } else {
                            startNewGame(days);
                        }
                    } else {
                        showAlert('å·²ä½¿ç”¨å–®æ©Ÿæ¨¡å¼å»ºç«‹æ–°ç´€éŒ„ï¼');
                        startNewGame(days);
                    }
                }
                
                document.getElementById('playerNameDisplay').innerText = `(ç´€éŒ„: ${name}${isOfflineMode ? ' - å–®æ©Ÿ' : ''})`;
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('gameArea').classList.remove('hidden');
                document.getElementById('gameArea').classList.add('flex');
                startTimer();
                
            } catch (err) {
                console.error("ä¸å¯é æœŸéŒ¯èª¤:", err);
                isOfflineMode = true;
                startNewGame(days);
                document.getElementById('loginSection').classList.add('hidden');
                document.getElementById('gameArea').classList.remove('hidden');
                document.getElementById('gameArea').classList.add('flex');
                startTimer();
            } finally {
                showLoading(false); 
            }
        });

        document.getElementById('switchPlayerBtn').addEventListener('click', (e) => {
            e.preventDefault();
            clearInterval(timerInterval);
            document.getElementById('gameArea').classList.add('hidden');
            document.getElementById('gameArea').classList.remove('flex');
            document.getElementById('loginSection').classList.remove('hidden');
            renderPlayerDropdown(); 
        });

        function startNewGame(days) {
            state.deadline = new Date(new Date().getTime() + days * 24 * 60 * 60 * 1000);
            state.pokes = 0; state.directBalls = 0; state.totalBalls = 0; state.isGameOver = false;
            initGame();
            startGame();
            saveProgress(true); 
        }

        function loadSavedGrid(gridData) {
            initInventory();
            const grid = document.getElementById('gameGrid');
            grid.innerHTML = ''; 
            gridData.forEach((data) => {
                const card = document.createElement('div');
                card.className = `card ${data.flipped ? 'flipped' : 'pointer-events-none'}`;
                card.innerHTML = `
                    <div class="card-inner">
                        <div class="card-front"><div class="pokeball-design"></div></div>
                        <div class="card-back">
                            <img src="${data.img}" class="w-full h-full object-contain" crossorigin="anonymous">
                        </div>
                    </div>
                `;
                card.onclick = () => handleFlip(card, data);
                grid.appendChild(card);
            });
        }

        function saveProgress(saveGrid = true) {
            try {
                const dataToSave = {
                    pokes: state.pokes, directBalls: state.directBalls, totalBalls: state.totalBalls,
                    isGameOver: state.isGameOver
                };
                
                let finalGrid = null;
                if (saveGrid || state.isGameOver) {
                    const gridItems = [];
                    document.querySelectorAll('.card').forEach(card => {
                        const backImg = card.querySelector('.card-back img');
                        if (backImg) {
                            gridItems.push({
                                type: backImg.src.includes('item') || backImg.src.includes('SVG') || backImg.src.includes('svg') ? 'ball' : 'pokemon',
                                img: backImg.src, flipped: card.classList.contains('flipped')
                            });
                        }
                    });
                    finalGrid = gridItems;
                    dataToSave.grid = finalGrid;
                }

                if (isOfflineMode) {
                    if (!finalGrid) {
                        const oldData = JSON.parse(localStorage.getItem(`pokemon_save_${currentUser}`)) || {};
                        finalGrid = oldData.grid || [];
                        dataToSave.grid = finalGrid;
                    }
                    const localData = { ...dataToSave, deadline: state.deadline.getTime() };
                    localStorage.setItem(`pokemon_save_${currentUser}`, JSON.stringify(localData));
                    return;
                }

                dataToSave.deadline = Timestamp.fromDate(state.deadline);
                if (userDocRef && db) {
                    fetchWithTimeout(setDoc(userDocRef, dataToSave, { merge: true }), 2000).catch(() => {
                        isOfflineMode = true; 
                    });
                }
            } catch (err) {
                console.warn("å­˜æª”å¤±æ•—");
            }
        }

        function startTimer() {
            if (timerInterval) clearInterval(timerInterval);
            const timerEl = document.getElementById('timer');
            timerInterval = setInterval(() => {
                const distance = state.deadline.getTime() - new Date().getTime();
                if (distance < 0) {
                    clearInterval(timerInterval);
                    timerEl.innerText = "å·²éæœŸ";
                    if (!state.isGameOver) { state.isGameOver = true; showAlert('æ™‚é–“åˆ°ï¼æŒ‘æˆ°å¤±æ•—ã€‚'); saveProgress(true); }
                    return;
                }
                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const secs = Math.floor((distance % (1000 * 60)) / 1000);
                
                let timeStr = `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                timerEl.innerText = days > 0 ? `${days}å¤© ` + timeStr : timeStr;
            }, 1000);
        }
    </script>
</body>
</html>